# BMW F-Series Shifter Controller

Контроллер для BMW F-Series шифтера на базе ESP32-S3 и Windows приложения.

## Структура проекта

### ESP32-S3 (main/)
- `bmw_shifter.h/c` - Определения CAN ID, CRC функции, логика определения передачи
- `serial_protocol.h/c` - Протокол обмена данными через Serial (JSON)
- `main.c` - Основной код: прием CAN, отправка ответов, коммуникация с приложением

### Windows приложение (BmwShifterApp/)
- WPF приложение на .NET 9.0
- CAN монитор с overwrite функциональностью
- Управление подсветкой шифтера
- Отображение состояния шифтера

## Сборка и запуск

### ESP32-S3

1. Установите ESP-IDF 5.5.2
2. Подключите ESP32-S3 к шифтеру:
   - TX GPIO: 5
   - RX GPIO: 4
   - Скорость CAN: 500 kbps
3. Соберите проект:
   ```bash
   idf.py build
   idf.py flash monitor
   ```

### Windows приложение

1. Установите .NET 9.0 SDK
2. Откройте проект в Visual Studio или используйте командную строку:
   ```bash
   cd BmwShifterApp
   dotnet restore
   dotnet build
   dotnet run
   ```

## Использование

1. Подключите ESP32-S3 к компьютеру через USB
2. Запустите Windows приложение
3. Выберите COM порт в приложении
4. Нажмите "Подключить"
5. Перемещайте рычаг шифтера - состояние будет отображаться в реальном времени

## CAN протокол

### Прием от шифтера:
- **ID 0x197** (407) - Положение рычага (30мс)
  - Byte 2: позиция рычага (0x0E, 0x1E, 0x2E, 0x3E, 0x4E, 0x7E, 0x5E, 0x6E)
  - Byte 3: кнопка Park (0xC0 нормально, 0xD5 нажата)
- **ID 0x55E** - Heartbeat от шифтера (640мс)

### Отправка шифтеру:
- **ID 0x3FD** (1021) - Отображение передачи (100мс)
  - Byte 3: индикация (0x20=P, 0x40=R, 0x60=N, 0x81=D/M)
  - Требует CRC в byte 1, счетчик в byte 2
- **ID 0x202** (514) - Подсветка (1000мс)
  - Byte 1: уровень подсветки (0-254)
- **ID 0x55E** - Heartbeat ответ (640мс)

## Особенности

- **CRC расчет**: Используется таблица CRC из egs_utils.lua
- **Overwrite режим**: CAN монитор обновляет существующие сообщения вместо добавления новых
- **Serial протокол**: JSON формат для обмена данными между ESP32 и приложением

## Лицензия

Проект создан для личного использования.

